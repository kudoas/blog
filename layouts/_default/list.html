{{ define "main" }}

<main class="main inner" data-sidebar-position="{{ $.Param "sidebarPosition" }}">
  <div class="list__main {{ if $.Param "enableSidebar" }}{{ if eq ($.Param "sidebarPosition") "left" }}mr{{ else }}lm{{ end }}{{ else }}lmr{{ end }}">
    {{ partial "body/breadcrumb" . }}
    <header class="list__header">
      <h5 class="list__header--title capitalize h5">{{ .Title }}</h5>
    </header>

    {{ with .Content }}
    <div class="list__header--desc single__contents p2">
      {{ . }}
    </div>
    {{ end }}

    <div class="summary__container" data-display="block">
      {{/* ローカル記事とZenn記事を混在させてソート（作成日降順） */}}
      {{ $items := slice }}
      {{ $localPages := where .Pages "Type" .Type }}
      {{ range $localPages }}
        {{ $items = $items | append (dict
          "kind" "local"
          "page" .
          "date" .Date
        ) }}
      {{ end }}

      {{/* Zenn記事を取得（デフォルトは data/zenn.json、HUGO_ZENN_FETCH=1 か params.enableZennRemote=true でリモートフェッチ） */}}
      {{ $api := "https://www.da1chi.net/api/zenn/articles?username=da1chi" }}
      {{ $enableRemote := or (eq (getenv "HUGO_ZENN_FETCH") "1") (default false $.Site.Params.enableZennRemote) }}
      {{ $zennResp := site.Data.zenn | default dict }}
      {{ if $enableRemote }}
        {{ with resources.GetRemote $api }}
          {{ with . | transform.Unmarshal }}
            {{ $zennResp = . }}
          {{ end }}
        {{ end }}
      {{ end }}
      {{ range $zennResp.articles }}
        {{ $d := time .published_at }}
        {{ $items = $items | append (dict
          "kind" "zenn"
          "data" .
          "date" $d
        ) }}
      {{ end }}

      {{ $sorted := sort $items "date" "desc" }}
      {{ range $sorted }}
        {{ if eq .kind "local" }}
          {{ .page.Render "summary" }}
        {{ else if eq .kind "zenn" }}
          {{ partial "zenn/summary" (dict "page" $ "item" .data) }}
        {{ end }}
      {{ end }}
    </div>
    {{ partial "search/search-result-desktop" . }}
  </div>

  {{ if $.Param "enableSidebar" }}
  <aside class="list__sidebar {{ if eq ($.Param "sidebarPosition") "left" }}l{{ else }}r{{ end }}" data-dir="{{ $.Param "languagedir" | default "ltr" }}">
    {{ partial "sidebar/sidebar-list" . }}
  </aside>
  {{ end }}
</main>

{{ partial "script/sidebar-script" . }}
{{ partial "script/list-script" . }}
{{ end }}
